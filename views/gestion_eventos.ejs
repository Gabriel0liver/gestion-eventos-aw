<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Eventos</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>
<body>

    <!-- Lista de Eventos -->
<div class="container mt-5">
    <h1>Lista de Eventos</h1>
    <div id="eventos-container"></div>

    <!-- Modal Detalle -->
    <div class="modal fade" id="modalDetalle" tabindex="-1" aria-labelledby="modalDetalleLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalDetalleLabel">Detalle del Evento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="detalleEvento">
                    <!-- TODO -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Eliminar -->
    <div class="modal fade" id="modalEliminar" tabindex="-1" aria-labelledby="modalEliminarLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEliminarLabel">Eliminar Evento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    ¿Estás seguro de que deseas eliminar este evento?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="btnEliminar">Eliminar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Editar -->
    <div class="modal fade" id="modalEditar" tabindex="-1" aria-labelledby="modalEditarLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEditarLabel">Editar Evento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formEditarEvento">
                        <input type="hidden" id="eventoId">
                        <div class="mb-3">
                            <label for="titulo" class="form-label">Título</label>
                            <input type="text" class="form-control" id="titulo" required>
                        </div>
                        <div class="mb-3">
                            <label for="descripcion" class="form-label">Descripción</label>
                            <textarea class="form-control" id="descripcion" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="fecha" class="form-label">Fecha</label>
                            <input type="date" class="form-control" id="fecha" required>
                        </div>
                        <div class="mb-3">
                            <label for="hora" class="form-label">Hora</label>
                            <input type="time" class="form-control" id="hora" required>
                        </div>
                        <div class="mb-3">
                            <label for="ubicacion" class="form-label">Ubicación</label>
                            <input type="text" class="form-control" id="ubicacion" required>
                        </div>
                        <div class="mb-3">
                            <label for="capacidad_maxima" class="form-label">Capacidad Máxima</label>
                            <input type="number" class="form-control" id="capacidad_maxima" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Guardar cambios</button>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    $(document).ready(function () {
    //Cargar eventos
    $.ajax({
        url: '/eventos/mis-eventos',
        method: 'GET',
        dataType: 'json',
        success: function (data) {
            $('#eventos-container').empty();
            if (data.eventos.length > 0) {
                let tabla = `
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Título</th>
                                <th>Descripción</th>
                                <th>Fecha</th>
                                <th>Hora</th>
                                <th>Ubicación</th>
                                <th>Capacidad Máxima</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                data.eventos.forEach(evento => {
                    tabla += 
                        `<tr data-id="${evento.id}">
                            <td>${evento.titulo}</td>
                            <td>${evento.descripcion}</td>
                            <td>${evento.fecha}</td>
                            <td>${evento.hora}</td>
                            <td>${evento.ubicacion}</td>
                            <td>${evento.capacidad_maxima}</td>
                            <td>
                                <button class="btn btn-info btn-sm btnDetalle">Detalle</button>
                                <button class="btn btn-warning btn-sm btnEditar">Editar</button>
                                <button class="btn btn-danger btn-sm btnEliminar">Eliminar</button>
                            </td>
                        </tr>`;
                    });
                    tabla += `</tbody></table>`;
                    $('#eventos-container').html(tabla);
                } else {
                    $('#eventos-container').html('<p class="text-muted">No tienes eventos creados.</p>');
                }
            },
            error: function (err) {
                console.error('Error al cargar eventos:', err);
                $('#eventos-container').html('<p class="text-danger">Error al cargar los eventos.</p>');
            }
        });

        // Mostrar en detalle
        $(document).on('click', '.btnDetalle', function () {
            const eventoId = $(this).closest('tr').data('id');
            $.ajax({
                url: `/eventos/detalle/${eventoId}`,
                method: 'GET',
                dataType: 'json',
                success: function (data) {
                    $('#detalleEvento').html(`
                        <strong>Título:</strong> ${data.evento.titulo} <br>
                        <strong>Descripción:</strong> ${data.evento.descripcion} <br>
                        <strong>Fecha:</strong> ${data.evento.fecha} <br>
                        <strong>Hora:</strong> ${data.evento.hora} <br>
                        <strong>Ubicación:</strong> ${data.evento.ubicacion} <br>
                        <strong>Capacidad Máxima:</strong> ${data.evento.capacidad_maxima} <br>
                    `);
                    $('#modalDetalle').modal('show');
                }
            });
        });

        // Mostrar en modal de edición
        $(document).on('click', '.btnEditar', function () {
            const eventoId = $(this).closest('tr').data('id');
            $.ajax({
                url: `/eventos/detalle/${eventoId}`,
                method: 'GET',
                dataType: 'json',
                success: function (data) {
                    const evento = data.evento;
                    $('#eventoId').val(evento.id);
                    $('#titulo').val(evento.titulo);
                    $('#descripcion').val(evento.descripcion);
                    $('#fecha').val(evento.fecha);
                    $('#hora').val(evento.hora);
                    $('#ubicacion').val(evento.ubicacion);
                    $('#capacidad_maxima').val(evento.capacidad_maxima);
                    $('#modalEditar').modal('show');
                }
            });
        });

        // Enviar los cambios de la edición
        $('#formEditarEvento').submit(function (e) {
            e.preventDefault();
            const eventoId = $('#eventoId').val();
            const eventoData = {
                titulo: $('#titulo').val(),
                descripcion: $('#descripcion').val(),
                fecha: $('#fecha').val(),
                hora: $('#hora').val(),
                ubicacion: $('#ubicacion').val(),
                capacidad_maxima: $('#capacidad_maxima').val()
            };

            $.ajax({
                url: `/eventos/editar/${eventoId}`,
                method: 'PUT',
                data: eventoData,
                success: function (data) {
                    $('#modalEditar').modal('hide');
                    alert('Evento actualizado con éxito.');
                    location.reload();
                },
                error: function (err) {
                    alert('Error al editar el evento.');
                    console.error(err);
                }
            });
        });
    });
</script>

</body>
</html>
